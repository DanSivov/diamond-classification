<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diamond Classification System</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropbox.js/10.34.0/Dropbox-sdk.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <section id="step-login" class="step-section active">
            <div class="login-container">
                <h2>Sign In</h2>
                <p>Enter your email to access the Diamond Classification System</p>

                <input type="email" id="login-email" placeholder="your.email@example.com" autocomplete="email">
                <button onclick="handleLogin()" class="btn-primary">Continue</button>
            </div>
        </section>

        <!-- User Bar (shown after login) -->
        <div id="user-bar" class="user-bar" style="display: none;">
            <div class="user-info">
                Signed in as <span class="user-email" id="current-user-email"></span>
            </div>
            <div style="display: flex; gap: 12px;">
                <button onclick="showManageJobs()" class="btn-logout">Manage Jobs</button>
                <button onclick="handleLogout()" class="btn-logout">Sign Out</button>
            </div>
        </div>

        <!-- Header (shown after login) -->
        <header id="main-header" style="display: none;">
            <h1>Diamond Classification System</h1>
            <p class="subtitle">Verification and Training Data Collection</p>
        </header>

        <!-- Step 1: Dashboard -->
        <section id="step-dashboard" class="step-section">
            <h2>Dashboard</h2>
            <p>What would you like to do?</p>

            <div class="button-group-vertical">
                <button onclick="startNewJob()" class="btn-primary">Start New Verification Job</button>
                <button onclick="showPreviousJobs()" class="btn-primary">Continue Previous Verification</button>
            </div>
        </section>

        <!-- Step 2: Previous Jobs List -->
        <section id="step-previous-jobs" class="step-section">
            <h2>Your Previous Jobs</h2>
            <p>Select a job to continue verification</p>

            <div id="jobs-list" class="job-list"></div>

            <div style="margin-top: 24px;">
                <button onclick="showStep('dashboard')" class="btn-secondary">Back to Dashboard</button>
            </div>
        </section>

        <!-- Manage Jobs Section -->
        <section id="step-manage-jobs" class="step-section">
            <h2>Manage Jobs</h2>
            <p>View, continue, or delete your verification jobs</p>

            <div id="manage-jobs-list" class="job-list"></div>

            <div style="margin-top: 24px;">
                <button onclick="showStep('dashboard')" class="btn-secondary">Back to Dashboard</button>
            </div>
        </section>

        <!-- Step 3: New Job Source Selection -->
        <section id="step-new-job-source" class="step-section">
            <h2>Select Image Source</h2>
            <p>Choose where to load images from</p>

            <div class="button-group-vertical">
                <button onclick="selectFromDropbox()" class="btn-primary">Select from Dropbox</button>
                <button onclick="selectFromComputer()" class="btn-primary">Upload from Computer</button>
            </div>

            <div style="margin-top: 24px;">
                <button onclick="showStep('dashboard')" class="btn-secondary">Back to Dashboard</button>
            </div>
        </section>

        <!-- Step 2: Upload Existing - Choose Source -->
        <section id="step-upload-existing" class="step-section">
            <h2>Upload Existing Classification</h2>
            <p>Choose where to load from:</p>

            <div class="button-group-horizontal">
                <button onclick="uploadFromComputer()" class="btn-primary">Upload from Computer</button>
                <button onclick="loadFromDropbox()" class="btn-primary">Load from Dropbox</button>
            </div>

            <div style="margin-top: 20px;">
                <button onclick="goToStart()" class="btn-secondary">Back</button>
            </div>
        </section>

        <!-- Step 2a: Upload from Computer -->
        <section id="step-upload-computer" class="step-section">
            <h2>Upload Classification Package</h2>
            <p>Select the ZIP file containing JSON and graded images</p>

            <input type="file" id="existing-zip-upload" accept=".zip">
            <div class="button-group-horizontal">
                <button onclick="loadExistingClassification()">Load Classification</button>
                <button onclick="uploadExisting()" class="btn-secondary">Back</button>
            </div>
        </section>

        <!-- Step 3: New Classification - Choose Source -->
        <section id="step-new-classification-source" class="step-section">
            <h2>New Classification</h2>
            <p>Choose where to load images from:</p>

            <div class="button-group-horizontal">
                <button onclick="processFromComputer()" class="btn-primary">Process from Computer</button>
                <button onclick="processFromDropbox()" class="btn-primary">Process from Dropbox</button>
            </div>

            <div style="margin-top: 20px;">
                <button onclick="goToStart()" class="btn-secondary">Back</button>
            </div>
        </section>

        <!-- Step 3a: New Classification - Computer -->
        <section id="step-new-classification" class="step-section">
            <h2>Process Images from Computer</h2>
            <p>Select images to classify</p>

            <input type="file" id="new-image-upload" accept=".jpg,.jpeg,.png,.jp2" multiple>
            <div class="button-group-horizontal">
                <button onclick="processImages()">Process Images</button>
                <button onclick="beginNewClassification()" class="btn-secondary">Back</button>
            </div>
        </section>

        <!-- Step 3.5: Processing -->
        <section id="step-processing" class="step-section">
            <h2>Processing Images</h2>
            <div id="processing-status"></div>
        </section>

        <!-- Step 3.6: Fallback when API unavailable -->
        <section id="step-processing-fallback" class="step-section">
            <h2>API Server Unavailable</h2>
            <p>Process images locally then upload results</p>

            <div class="info-box">
                <p>Run this command locally:</p>
                <p><code>python process_batch.py path/to/your/images/</code></p>
                <p>Then upload the generated JSON file from:</p>
                <p><code>output/graded_shared_final_json/</code></p>
            </div>

            <input type="file" id="fallback-json-upload" accept=".json">
            <div class="button-group-horizontal">
                <button onclick="loadFallbackResults()">Load Results</button>
                <button onclick="goToStart()" class="btn-secondary">Cancel</button>
            </div>
        </section>

        <!-- Job Summary (Async Processing Complete) -->
        <section id="step-job-summary" class="step-section">
            <h2>Job Processing Complete</h2>
            <div id="job-summary-content"></div>

            <div class="button-group-vertical">
                <button onclick="startJobVerification()" class="btn-primary">Start Verification</button>
                <button onclick="exportJobLabels()" class="btn-primary">Export Labels</button>
                <button onclick="goToStart()" class="btn-secondary">Start Over</button>
            </div>
        </section>

        <!-- Step 4: Check or Save -->
        <section id="step-check-or-save" class="step-section">
            <h2>Classification Loaded</h2>
            <div id="classification-summary"></div>

            <p>What would you like to do?</p>
            <div class="button-group-vertical">
                <button onclick="startVerification()" class="btn-primary">Check Classifier</button>
                <button onclick="saveDirectly()" class="btn-primary">Save Final Images</button>
                <button onclick="goToStart()" class="btn-secondary">Start Over</button>
            </div>
        </section>

        <!-- Step 5: Verification -->
        <section id="step-verification" class="step-section">
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
                <span id="progress-text">0 / 0</span>
            </div>

            <div class="roi-display">
                <div class="image-panel">
                    <h3>Context View</h3>
                    <canvas id="context-canvas"></canvas>
                </div>
                <div class="image-panel">
                    <h3 id="roi-title">ROI</h3>
                    <canvas id="roi-canvas"></canvas>
                    <div class="roi-info">
                        <p><strong>Type:</strong> <span id="roi-type">-</span></p>
                        <p><strong>Orientation:</strong> <span id="roi-orientation">-</span></p>
                        <p><strong>Confidence:</strong> <span id="roi-confidence">-</span></p>
                    </div>
                </div>
            </div>

            <div class="button-group-grid">
                <button class="btn-correct" onclick="verifyCorrect()">Correct (Y)</button>
                <button class="btn-wrong" onclick="verifyWrong()">Wrong (N)</button>
                <button class="btn-sam-fail" onclick="verifySAMFailure()">SAM Fail (F)</button>
                <button class="btn-skip" onclick="verifySkip()">Skip (S)</button>
                <button class="btn-quit" onclick="verifyQuit()">Quit (Q)</button>
            </div>
        </section>

        <!-- Step 6: Save Results -->
        <section id="step-save-results" class="step-section">
            <h2>Verification Complete</h2>
            <div id="verification-summary"></div>

            <p>Timestamp: <span id="save-timestamp"></span></p>
            <p>Choose where to save your results:</p>

            <div class="button-group-vertical">
                <button onclick="saveToDropbox()" class="btn-primary">Save to Dropbox</button>
                <button onclick="downloadResults()" class="btn-primary">Download to Computer</button>
                <button onclick="goToStart()" class="btn-secondary">Finish Without Saving</button>
            </div>
        </section>

        <!-- Step 7: Save Directly -->
        <section id="step-save-directly" class="step-section">
            <h2>Save Classification Results</h2>
            <p>Choose where to save your classification results:</p>

            <div class="button-group-vertical">
                <button onclick="saveClassificationToDropbox()" class="btn-primary">Save to Dropbox</button>
                <button onclick="downloadClassification()" class="btn-primary">Download to Computer</button>
                <button onclick="goToStart()" class="btn-secondary">Finish Without Saving</button>
            </div>
        </section>
    </div>

    <!-- Modal for Wrong Classification -->
    <div id="correction-modal" class="modal">
        <div class="modal-content">
            <h2>Correct Classification</h2>
            <p>Predicted: <span id="modal-prediction"></span></p>

            <div class="form-group">
                <label>Correct Orientation:</label>
                <select id="correct-orientation">
                    <option value="table">Table</option>
                    <option value="tilted">Tilted</option>
                </select>
            </div>

            <div class="form-group">
                <label>Correct Diamond Type:</label>
                <select id="correct-type">
                    <option value="round">Round</option>
                    <option value="emerald">Emerald</option>
                    <option value="other">Other</option>
                </select>
            </div>

            <div class="modal-buttons">
                <button onclick="submitCorrection()">Submit</button>
                <button onclick="closeCorrectionModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Modal for Dropbox File Browser -->
    <div id="dropbox-browser-modal" class="modal">
        <div class="modal-content dropbox-browser">
            <h2>Select Images from Dropbox</h2>

            <div class="breadcrumb-container">
                <span class="breadcrumb-label">Path:</span>
                <div id="breadcrumb-path" class="breadcrumb-path"></div>
            </div>

            <div id="file-browser-content" class="file-browser">
                <div class="browser-loading">Loading...</div>
            </div>

            <div class="browser-footer">
                <div class="selected-count">
                    <span id="selected-count">0 files selected</span>
                </div>
                <div class="modal-buttons">
                    <button onclick="selectAllDropboxImages()" class="btn-secondary">Select All</button>
                    <button onclick="deselectAllDropboxImages()" class="btn-secondary">Deselect All</button>
                    <button onclick="processSelectedDropboxFiles()" class="btn-primary">Process Selected</button>
                    <button onclick="closeDropboxBrowser()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>
