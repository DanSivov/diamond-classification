<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diamond Classification System</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Diamond Classification System</h1>
            <p class="subtitle">ML-Based Diamond Orientation Detection</p>
        </header>

        <!-- Step 1: Start -->
        <section id="step-start" class="step-section active">
            <h2>Get Started</h2>
            <p>Upload existing classification or begin new classification</p>

            <div class="button-group-vertical">
                <button onclick="uploadExisting()" class="btn-primary">Upload Existing Classification</button>
                <button onclick="beginNewClassification()" class="btn-primary">Begin New Classification</button>
            </div>
        </section>

        <!-- Step 2: Upload Existing -->
        <section id="step-upload-existing" class="step-section">
            <h2>Upload Classification Package</h2>
            <p>Select the ZIP file containing JSON and graded images</p>

            <input type="file" id="existing-zip-upload" accept=".zip">
            <div class="button-group-horizontal">
                <button onclick="loadExistingClassification()">Load Classification</button>
                <button onclick="goToStart()" class="btn-secondary">Back</button>
            </div>
        </section>

        <!-- Step 3: New Classification -->
        <section id="step-new-classification" class="step-section">
            <h2>New Classification</h2>
            <p>Select images to classify</p>

            <input type="file" id="new-image-upload" accept=".jpg,.jpeg,.png,.jp2" multiple>
            <div class="button-group-horizontal">
                <button onclick="processImages()">Process Images</button>
                <button onclick="goToStart()" class="btn-secondary">Back</button>
            </div>
        </section>

        <!-- Step 3.5: Processing -->
        <section id="step-processing" class="step-section">
            <h2>Processing Images</h2>
            <div id="processing-status"></div>
        </section>

        <!-- Step 3.6: Fallback when API unavailable -->
        <section id="step-processing-fallback" class="step-section">
            <h2>API Server Unavailable</h2>
            <p>Process images locally then upload results</p>

            <div class="info-box">
                <p>Run this command locally:</p>
                <p><code>python process_batch.py path/to/your/images/</code></p>
                <p>Then upload the generated JSON file from:</p>
                <p><code>output/graded_shared_final_json/</code></p>
            </div>

            <input type="file" id="fallback-json-upload" accept=".json">
            <div class="button-group-horizontal">
                <button onclick="loadFallbackResults()">Load Results</button>
                <button onclick="goToStart()" class="btn-secondary">Cancel</button>
            </div>
        </section>

        <!-- Step 4: Check or Save -->
        <section id="step-check-or-save" class="step-section">
            <h2>Classification Loaded</h2>
            <div id="classification-summary"></div>

            <p>What would you like to do?</p>
            <div class="button-group-vertical">
                <button onclick="startVerification()" class="btn-primary">Check Classifier</button>
                <button onclick="saveDirectly()" class="btn-primary">Save Final Images</button>
                <button onclick="goToStart()" class="btn-secondary">Start Over</button>
            </div>
        </section>

        <!-- Step 5: Verification -->
        <section id="step-verification" class="step-section">
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
                <span id="progress-text">0 / 0</span>
            </div>

            <div class="roi-display">
                <div class="image-panel">
                    <h3>Context View</h3>
                    <canvas id="context-canvas"></canvas>
                </div>
                <div class="image-panel">
                    <h3 id="roi-title">ROI</h3>
                    <canvas id="roi-canvas"></canvas>
                    <div class="roi-info">
                        <p><strong>Type:</strong> <span id="roi-type">-</span></p>
                        <p><strong>Orientation:</strong> <span id="roi-orientation">-</span></p>
                        <p><strong>Confidence:</strong> <span id="roi-confidence">-</span></p>
                    </div>
                </div>
            </div>

            <div class="button-group-grid">
                <button class="btn-correct" onclick="verifyCorrect()">Correct (Y)</button>
                <button class="btn-wrong" onclick="verifyWrong()">Wrong (N)</button>
                <button class="btn-skip" onclick="verifySkip()">Skip (S)</button>
                <button class="btn-quit" onclick="verifyQuit()">Quit (Q)</button>
            </div>
        </section>

        <!-- Step 6: Save Results -->
        <section id="step-save-results" class="step-section">
            <h2>Verification Complete</h2>
            <div id="verification-summary"></div>

            <p>Progress saved to codebase with timestamp: <span id="save-timestamp"></span></p>
            <p>Would you like to save results to your machine?</p>

            <div class="button-group-vertical">
                <button onclick="downloadResults()" class="btn-primary">Download Results</button>
                <button onclick="goToStart()" class="btn-secondary">Finish</button>
            </div>
        </section>

        <!-- Step 7: Save Directly -->
        <section id="step-save-directly" class="step-section">
            <h2>Save Final Images</h2>
            <p>Download the classification results</p>

            <div class="button-group-vertical">
                <button onclick="downloadClassification()" class="btn-primary">Download Classification Data</button>
                <button onclick="goToStart()" class="btn-secondary">Finish</button>
            </div>
        </section>
    </div>

    <!-- Modal for Wrong Classification -->
    <div id="correction-modal" class="modal">
        <div class="modal-content">
            <h2>Correct Classification</h2>
            <p>Predicted: <span id="modal-prediction"></span></p>

            <div class="form-group">
                <label>Correct Orientation:</label>
                <select id="correct-orientation">
                    <option value="table">Table</option>
                    <option value="tilted">Tilted</option>
                </select>
            </div>

            <div class="form-group">
                <label>Correct Diamond Type:</label>
                <select id="correct-type">
                    <option value="round">Round</option>
                    <option value="emerald">Emerald</option>
                    <option value="other">Other</option>
                </select>
            </div>

            <div class="modal-buttons">
                <button onclick="submitCorrection()">Submit</button>
                <button onclick="closeCorrectionModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>
