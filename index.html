<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diamond Classification Verification System</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <h1>Diamond Classification & Verification</h1>
            <p class="subtitle">ML-Based Diamond Orientation Detection System</p>
        </header>

        <!-- Navigation Tabs -->
        <nav class="tabs">
            <button class="tab-button active" onclick="switchTab('batch-review')">Batch Review</button>
            <button class="tab-button" onclick="switchTab('roi-verification')">ROI Verification</button>
            <button class="tab-button" onclick="switchTab('statistics')">Statistics</button>
            <button class="tab-button" onclick="switchTab('help')">Help</button>
        </nav>

        <!-- Tab: Batch Review -->
        <section id="batch-review" class="tab-content active">
            <div class="upload-section">
                <h2>Upload Classification Results</h2>
                <p>Upload JSON files generated by <code>process_batch.py</code></p>
                <input type="file" id="json-upload" accept=".json" multiple>
                <button onclick="loadJSONFiles()">Load Results</button>
            </div>

            <div id="batch-results" class="results-container">
                <p class="placeholder">No results loaded. Upload JSON files to begin.</p>
            </div>
        </section>

        <!-- Tab: ROI Verification -->
        <section id="roi-verification" class="tab-content">
            <div class="upload-section">
                <h2>Interactive ROI Verification</h2>
                <p>Upload verification data from <code>verify_interactive.py</code> or start new verification session</p>

                <div class="upload-group">
                    <div>
                        <label>Classification JSON:</label>
                        <input type="file" id="roi-json-upload" accept=".json">
                    </div>
                    <div>
                        <label>Image Files:</label>
                        <input type="file" id="roi-image-upload" accept=".jpg,.jpeg,.png" multiple>
                    </div>
                </div>
                <button onclick="startVerification()">Start Verification</button>
            </div>

            <div id="verification-container" class="verification-section">
                <!-- Dynamic verification UI will be inserted here -->
            </div>

            <div id="verification-controls" class="controls-section" style="display: none;">
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill"></div>
                    <span id="progress-text">0 / 0</span>
                </div>

                <div class="roi-display">
                    <div class="image-panel">
                        <h3>Context View</h3>
                        <canvas id="context-canvas"></canvas>
                    </div>
                    <div class="image-panel">
                        <h3 id="roi-title">ROI #0</h3>
                        <canvas id="roi-canvas"></canvas>
                        <div class="roi-info">
                            <p><strong>Type:</strong> <span id="roi-type">-</span></p>
                            <p><strong>Orientation:</strong> <span id="roi-orientation">-</span></p>
                            <p><strong>Confidence:</strong> <span id="roi-confidence">-</span></p>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn-correct" onclick="verifyCorrect()">✓ Correct (Y)</button>
                    <button class="btn-wrong" onclick="verifyWrong()">✗ Wrong (N)</button>
                    <button class="btn-skip" onclick="verifySkip()">⊘ Skip (S)</button>
                    <button class="btn-quit" onclick="verifyQuit()">Quit & Export (Q)</button>
                </div>
            </div>
        </section>

        <!-- Tab: Statistics -->
        <section id="statistics" class="tab-content">
            <h2>Classification Statistics</h2>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Verified</h3>
                    <p class="stat-value" id="stat-total">0</p>
                </div>
                <div class="stat-card">
                    <h3>Accuracy</h3>
                    <p class="stat-value" id="stat-accuracy">-</p>
                </div>
                <div class="stat-card">
                    <h3>Table Diamonds</h3>
                    <p class="stat-value" id="stat-table">0</p>
                </div>
                <div class="stat-card">
                    <h3>Tilted Diamonds</h3>
                    <p class="stat-value" id="stat-tilted">0</p>
                </div>
            </div>

            <div class="chart-container">
                <h3>Diamond Type Distribution</h3>
                <canvas id="type-chart"></canvas>
            </div>

            <div class="chart-container">
                <h3>Verification History</h3>
                <div id="verification-log" class="log-container">
                    <p class="placeholder">No verification data available</p>
                </div>
            </div>

            <button onclick="exportVerifications()" class="btn-export">Download Verification Data (JSON)</button>
            <button onclick="exportCSV()" class="btn-export">Download Training Data (CSV)</button>
        </section>

        <!-- Tab: Help -->
        <section id="help" class="tab-content">
            <h2>How to Use</h2>

            <div class="help-section">
                <h3>1. Batch Review Mode</h3>
                <p>Review classification results from batch processing:</p>
                <ol>
                    <li>Run <code>python process_batch.py path/to/images/</code> locally</li>
                    <li>Upload the generated JSON files from <code>output/graded_shared_final_json/</code></li>
                    <li>Review results and statistics</li>
                </ol>
            </div>

            <div class="help-section">
                <h3>2. ROI Verification Mode</h3>
                <p>Interactively verify individual diamond classifications:</p>
                <ol>
                    <li>Upload classification JSON and corresponding images</li>
                    <li>Review each ROI (Region of Interest)</li>
                    <li>Use keyboard shortcuts:
                        <ul>
                            <li><kbd>Y</kbd> - Mark as correct</li>
                            <li><kbd>N</kbd> - Mark as wrong (prompts for correction)</li>
                            <li><kbd>S</kbd> - Skip (uncertain)</li>
                            <li><kbd>Q</kbd> - Quit and export verification data</li>
                        </ul>
                    </li>
                    <li>Export verification data for model retraining</li>
                </ol>
            </div>

            <div class="help-section">
                <h3>3. Model Retraining</h3>
                <p>Use verified data to improve the model:</p>
                <ol>
                    <li>Complete ROI verification session</li>
                    <li>Download verification data (JSON)</li>
                    <li>Run <code>python export_training_data.py verifications.json path/to/images/</code></li>
                    <li>Use generated CSV for model retraining</li>
                </ol>
            </div>

            <div class="help-section">
                <h3>Model Information</h3>
                <ul>
                    <li><strong>Model Type:</strong> Random Forest Classifier</li>
                    <li><strong>Accuracy:</strong> 95.6% on validation set</li>
                    <li><strong>Features:</strong> 8 geometric features (symmetry, reflections, aspect ratio)</li>
                    <li><strong>Auto Detection:</strong> Diamond type automatically classified (round/emerald/other)</li>
                </ul>
            </div>
        </section>
    </div>

    <!-- Modal for Wrong Classification Correction -->
    <div id="correction-modal" class="modal">
        <div class="modal-content">
            <h2>Correct Classification</h2>
            <p>The predicted classification was: <span id="modal-prediction"></span></p>

            <div class="form-group">
                <label>Correct Orientation:</label>
                <select id="correct-orientation">
                    <option value="table">Table</option>
                    <option value="tilted">Tilted</option>
                </select>
            </div>

            <div class="form-group">
                <label>Correct Diamond Type:</label>
                <select id="correct-type">
                    <option value="round">Round</option>
                    <option value="emerald">Emerald</option>
                    <option value="other">Other</option>
                </select>
            </div>

            <div class="modal-buttons">
                <button onclick="submitCorrection()">Submit</button>
                <button onclick="closeCorrectionModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>
